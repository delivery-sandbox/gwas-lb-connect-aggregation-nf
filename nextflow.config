// Please do not change the order of the numbered sections!
// The expected order is: 1. Parameters - 2. Profiles - 3. Process -  4. Executor

// There is a high chance it would break the configuration of 'profiles'

// 0. Manifest

 manifest {
  name = 'iudlgnt-gwas-sumstats-utils'
  author = ''
  description = 'GWAS harmonisation pipeline'
  mainScript = 'main.nf'
  nextflowVersion = '>=19.10.0'
  version = '1.2.5'
}

// 1. Parameters

// NOTE: 
// Initialise the values of the params to the preferred default value or to false
params {
    // output folder options
    outdir          = 'results'
    tracedir        = "${params.outdir}/pipeline_info"

    // client-specific variables to be used in pipeline introspection reporting
    raci_owner        = "Lifebit"
    domain_keywords   = "GWAS; harmonisation; population-genomics"
    unique_identifier = "042bf2ae909ea03b9a909b0512e89d7c"
    
    // inputs
    input = false
    gwas_source = null
    standardise = false
    coef_conversion = false
    take_n_studies = -1
    miss_percent_allow = 10
    keep_intermediate_files = false
    omop_vocabulary = "https://omopvocabs.s3.eu-west-1.amazonaws.com/omop-vocab-clean.zip"
    convert_to_hail = false

    // Filter options
    filter_beta_smaller_than  = null 
    filter_beta_greater_than  = null
    filter_p_greater_than     = null
    filter_freq_smaller_than  = null
    filter_freq_greater_than  = null
    filter_missing_info       = false
    filter_info               = null
    

    // report_dir is:
    // - the folder from the container that includes the scripts for NF <= v20.01 (bin)
    // - the ${projectDir}/bin folder of the root of the repo with the scripts for NF >= v20.10
    report_dir = '/opt/bin/'

    // when set to true, prints help and exits
    help = false
    
    // default container for all processes, excluding those defined differently via the usage with 'withName'
    container = 'quay.io/lifebitai/gwas_fetch:1.0.0'

    // process resources defaults
    cpus   = 2
    memory = 2.GB
    disk   = '30.GB'
    
    // max resources limits defaults
    max_cpus   = 2
    max_memory = 16.GB
    max_time   = 8.h
    
    // execution related defaults
    config        = 'conf/standard.config'
    echo          = false
    errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'terminate' }
    maxRetries    = 9
    maxForks      = 200
    queueSize     = 200
    executor      = false
    med_memory     = 9.GB

    // google-lifesciences
    gls_bootDiskSize = '50.GB'
    gls_preemptible  = true
    zone             = 'us-east1-b'
    network          = 'default'
    subnetwork       = 'default'

    // AWS batch
    aws_region = 'eu-west-1'
    aws_batch_default_queue = "optimal-instance-1tb-ami-spot-queue"
    aws_batch_cli_path = '/home/ec2-user/miniconda/bin/aws' 
    aws_batch_fetch_instance_type = true
    aws_batch_max_parallel_transfers = 2
    aws_batch_volumes = '/home/ec2-user/.aws:/root/.aws'
}

// 2. Profiles


// Do not update the order because the values set in params scope will not be overwritten
// Do not attempt to simplify to 
// includeConfig params.config 
// outside of profiles scope, it will fail to update the values of the params
profiles {
    standard {includeConfig params.config}
    docker { docker.enabled = true }
    base {includeConfig 'conf/base.config'}
    awsbatch { includeConfig 'conf/aws-batch.config' }
    google {includeConfig 'conf/google.config'}
    cluster {includeConfig 'conf/cluster.config'}
    cluster_cloudos {includeConfig 'conf/cluster_cloudos.config'}
    test_ebi {includeConfig 'conf/test_ebi.config'}
    test_ebi_basic {includeConfig 'conf/test_ebi_basic.config'}
    test_ebi_basic_cloudos {includeConfig 'conf/test_ebi_basic_cloudos.config'}
    test_ebi_docker {includeConfig 'conf/test_ebi_docker.config'}
    test_ebi_info {includeConfig 'conf/test_ebi_info.config'}
    test_ieu {includeConfig 'conf/test_ieu.config'}
    test_ieu_cloudos {includeConfig 'conf/test_ieu_cloudos.config'}
    singularity {includeConfig 'conf/singularity.config'}
}

// 3. Process

// Do not change order of block, must follow after profiles scope (last section that updates params)
process {
    echo          = params.echo
    cpus          = params.cpus
    memory        = params.memory
    maxRetries    = params.maxRetries
    maxForks      = params.maxForks
    container     = params.container
    errorStrategy = params.errorStrategy
    queue         = "${params.aws_batch_default_queue}" 

    withLabel: munge {
        container = 'quay.io/lifebitai/mungesumstats:1.0.0'
        memory    = params.med_memory
    }
  
    withLabel: python {
        container = 'quay.io/lifebitai/cloudos-py:v0.0.5'
    }

    withName: map_traits {
        container = 'quay.io/lifebitai/etl-map-omop-vocabulary:latest'
    }

    withName: make_qc_plots {
      container = 'quay.io/lifebitai/gwas_qc_plots:latest'
      memory = params.med_memory
    }
    
    withName: filter_sumstats {
      container = 'quay.io/lifebitai/gwas:1.2dev'
    }
    withName: insert_metadata {
      memory = params.med_memory
    }
    
    withName: create_report {
      container = 'quay.io/lifebitai/report'
    }

    withName: vcf2hail {
      container = 'quay.io/lifebitai/hail:1.0.0'
    }

    withName: map_traits {
      memory = params.med_memory
    }
}

// 4. Executor - Do not remove this section! Required for running with different executors using --executor parameter

executor {
    name      = params.executor
    queueSize = params.queueSize
}

// 5. Nextflow timeline, report and trace reports

def trace_timestamp = new java.util.Date().format( 'yyyy-MM-dd_HH-mm-ss')
timeline {
    enabled = true
    file    = "${params.tracedir}/execution_timeline_${trace_timestamp}.html"
}
report {
    enabled = true
    file    = "${params.tracedir}/execution_report_${trace_timestamp}.html"
}
trace {
    enabled = true
    fields  = 'task_id,native_id,process,name,tag,status,exit,cpus,%cpu,memory,%mem,rss,vmem,peak_rss,peak_rss,container'
    file    = "${params.tracedir}/execution_trace_${trace_timestamp}.txt"
}

// 6. Manifest

manifest {
    name            = 'lifebit-ai/xxxx'
    homePage        = 'https://github.com/xxxx'
    description     = 'Pipeline description'
    mainScript      = 'main.nf'
    version         = "1.0dev"
}

// Function to ensure that resource requirements don't go beyond
// a maximum limit
def check_max(obj, type) {
  if (type == 'memory') {
    try {
      if (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1)
        return params.max_memory as nextflow.util.MemoryUnit
      else
        return obj
    } catch (all) {
      println "   ### ERROR ###   Max memory '${params.max_memory}' is not valid! Using default value: $obj"
      return obj
    }
  } else if (type == 'time') {
    try {
      if (obj.compareTo(params.max_time as nextflow.util.Duration) == 1)
        return params.max_time as nextflow.util.Duration
      else
        return obj
    } catch (all) {
      println "   ### ERROR ###   Max time '${params.max_time}' is not valid! Using default value: $obj"
      return obj
    }
  } else if (type == 'cpus') {
    try {
      return Math.min( obj, params.max_cpus as int )
    } catch (all) {
      println "   ### ERROR ###   Max cpus '${params.max_cpus}' is not valid! Using default value: $obj"
      return obj
    }
  }
}
